/* Auto-translated placeholder from TypeScript. */
let originalTs = "/**\n * Zotpress - Modern Frontend Module\n *\n * TypeScript implementation for Zotpress bibliography/citation functionality.\n * Replaces legacy jQuery-dependent code with modern, accessible patterns.\n *\n * @package Zotpress\n * @since 8.0.0\n */\n\n// Type definitions for WordPress globals\ndeclare const wp: {\n  ajax: {\n    post: (action: string, data: Record<string, unknown>) => Promise<unknown>;\n  };\n};\ndeclare const jQuery: JQueryStatic;\n\n/**\n * Zotpress configuration interface\n */\ninterface ZotpressConfig {\n  ajaxUrl: string;\n  nonce: string;\n  cacheTime: number;\n  debug: boolean;\n}\n\n/**\n * Zotero item interface\n */\ninterface ZoteroItem {\n  key: string;\n  version: number;\n  itemType: string;\n  title: string;\n  creators?: ZoteroCreator[];\n  date?: string;\n  DOI?: string;\n  URL?: string;\n  abstractNote?: string;\n  tags?: ZoteroTag[];\n}\n\ninterface ZoteroCreator {\n  creatorType: string;\n  firstName?: string;\n  lastName?: string;\n  name?: string;\n}\n\ninterface ZoteroTag {\n  tag: string;\n  type?: number;\n}\n\n/**\n * Main Zotpress class\n */\nclass Zotpress {\n  private readonly config: ZotpressConfig;\n  private cache: Map<string, { data: unknown; timestamp: number }>;\n\n  constructor(config: Partial<ZotpressConfig> = {}) {\n    this.config = {\n      ajaxUrl: '/wp-admin/admin-ajax.php',\n      nonce: '',\n      cacheTime: 600000, // 10 minutes\n      debug: false,\n      ...config,\n    };\n    this.cache = new Map();\n\n    this.init();\n  }\n\n  /**\n   * Initialize the module\n   */\n  private init(): void {\n    this.setupEventListeners();\n    this.initLazyLoading();\n    this.log('Zotpress initialized');\n  }\n\n  /**\n   * Set up event listeners using event delegation\n   */\n  private setupEventListeners(): void {\n    // Use event delegation instead of jQuery LiveQuery\n    document.addEventListener('click', (event: Event) => {\n      const target = event.target as HTMLElement;\n\n      // Handle citation clicks\n      if (target.closest('.zp-Citation-link')) {\n        event.preventDefault();\n        const link = target.closest('.zp-Citation-link') as HTMLAnchorElement;\n        this.handleCitationClick(link);\n      }\n\n      // Handle download clicks\n      if (target.closest('.zp-Attachment')) {\n        const attachment = target.closest('.zp-Attachment') as HTMLAnchorElement;\n        this.trackDownload(attachment);\n      }\n\n      // Handle pagination\n      if (target.closest('.zp-Pagination-btn')) {\n        event.preventDefault();\n        const btn = target.closest('.zp-Pagination-btn') as HTMLButtonElement;\n        this.handlePagination(btn);\n      }\n    });\n\n    // Handle form submissions\n    document.addEventListener('submit', (event: Event) => {\n      const form = event.target as HTMLFormElement;\n      if (form.classList.contains('zp-Search-form')) {\n        event.preventDefault();\n        this.handleSearch(form);\n      }\n    });\n  }\n\n  /**\n   * Initialize intersection observer for lazy loading\n   */\n  private initLazyLoading(): void {\n    if (!('IntersectionObserver' in window)) {\n      // Fallback for older browsers\n      this.loadAllBibliographies();\n      return;\n    }\n\n    const observer = new IntersectionObserver(\n      (entries) => {\n        entries.forEach((entry) => {\n          if (entry.isIntersecting) {\n            const container = entry.target as HTMLElement;\n            this.loadBibliography(container);\n            observer.unobserve(container);\n          }\n        });\n      },\n      {\n        rootMargin: '200px',\n        threshold: 0,\n      }\n    );\n\n    document.querySelectorAll('.zp-Zotpress[data-lazy]').forEach((el) => {\n      observer.observe(el);\n    });\n  }\n\n  /**\n   * Load all bibliographies (fallback for no IntersectionObserver)\n   */\n  private loadAllBibliographies(): void {\n    document.querySelectorAll('.zp-Zotpress[data-lazy]').forEach((el) => {\n      this.loadBibliography(el as HTMLElement);\n    });\n  }\n\n  /**\n   * Load bibliography content via AJAX\n   */\n  async loadBibliography(container: HTMLElement): Promise<void> {\n    const params = this.getDataParams(container);\n\n    if (!params.api_user_id) {\n      this.showError(container, 'Missing API user ID');\n      return;\n    }\n\n    // Check cache\n    const cacheKey = this.getCacheKey(params);\n    const cached = this.getFromCache(cacheKey);\n    if (cached) {\n      this.renderBibliography(container, cached as ZoteroItem[]);\n      return;\n    }\n\n    // Show loading state\n    this.showLoading(container);\n\n    try {\n      const response = await this.fetchData('zpRetrieveViaShortcode', params);\n      const items = response as ZoteroItem[];\n\n      // Cache the result\n      this.setCache(cacheKey, items);\n\n      // Render\n      this.renderBibliography(container, items);\n    } catch (error) {\n      this.showError(container, error instanceof Error ? error.message : 'Failed to load');\n      this.log('Load error:', error);\n    }\n  }\n\n  /**\n   * Fetch data from WordPress AJAX endpoint\n   */\n  private async fetchData(action: string, data: Record<string, unknown>): Promise<unknown> {\n    const formData = new FormData();\n    formData.append('action', action);\n    formData.append('_ajax_nonce', this.config.nonce);\n\n    Object.entries(data).forEach(([key, value]) => {\n      formData.append(key, String(value));\n    });\n\n    const response = await fetch(this.config.ajaxUrl, {\n      method: 'POST',\n      body: formData,\n      credentials: 'same-origin',\n    });\n\n    if (!response.ok) {\n      throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n    }\n\n    const result = await response.json();\n\n    if (result.success === false) {\n      throw new Error(result.data?.message || 'Request failed');\n    }\n\n    return result.data;\n  }\n\n  /**\n   * Get data attributes from container\n   */\n  private getDataParams(container: HTMLElement): Record<string, string> {\n    const params: Record<string, string> = {};\n\n    Array.from(container.attributes).forEach((attr) => {\n      if (attr.name.startsWith('data-')) {\n        const key = attr.name.slice(5).replace(/-/g, '_');\n        params[key] = attr.value;\n      }\n    });\n\n    return params;\n  }\n\n  /**\n   * Render bibliography items\n   */\n  private renderBibliography(container: HTMLElement, items: ZoteroItem[]): void {\n    container.removeAttribute('data-lazy');\n\n    if (items.length === 0) {\n      container.innerHTML = '<p class=\"zp-Message zp-Message--info\">No items found.</p>';\n      return;\n    }\n\n    const list = document.createElement('ul');\n    list.className = 'zp-List';\n    list.setAttribute('role', 'list');\n\n    items.forEach((item, index) => {\n      const li = document.createElement('li');\n      li.className = 'zp-Entry zp-animate-fadeIn';\n      li.style.animationDelay = `${index * 50}ms`;\n      li.innerHTML = this.renderItem(item, index + 1);\n      list.appendChild(li);\n    });\n\n    container.innerHTML = '';\n    container.appendChild(list);\n\n    // Announce to screen readers\n    this.announceToScreenReader(`Loaded ${items.length} bibliography items`);\n  }\n\n  /**\n   * Render a single item\n   */\n  private renderItem(item: ZoteroItem, num: number): string {\n    const authors = this.formatAuthors(item.creators || []);\n    const year = item.date ? new Date(item.date).getFullYear() : '';\n\n    return `\n      <span class=\"zp-Entry-num\">${num}.</span>\n      <div class=\"zp-Entry-content\">\n        <h3 class=\"zp-Entry-title\">\n          ${item.URL ? `<a href=\"${this.escapeHtml(item.URL)}\" class=\"zp-Citation-link\">${this.escapeHtml(item.title)}</a>` : this.escapeHtml(item.title)}\n        </h3>\n        <p class=\"zp-Entry-meta\">\n          ${authors ? `<span class=\"zp-Entry-authors\">${authors}</span>` : ''}\n          ${year ? `<span class=\"zp-Entry-year\">(${year})</span>` : ''}\n        </p>\n      </div>\n      <div class=\"zp-Entry-actions\">\n        ${item.DOI ? `<a href=\"https://doi.org/${this.escapeHtml(item.DOI)}\" class=\"zp-Attachment\" target=\"_blank\" rel=\"noopener\"><span class=\"zp-Attachment-icon\">ðŸ“„</span>DOI</a>` : ''}\n      </div>\n    `;\n  }\n\n  /**\n   * Format authors list\n   */\n  private formatAuthors(creators: ZoteroCreator[]): string {\n    const authors = creators.filter((c) => c.creatorType === 'author');\n    if (authors.length === 0) return '';\n\n    return authors\n      .map((a) => {\n        if (a.name) return a.name;\n        return [a.lastName, a.firstName].filter(Boolean).join(', ');\n      })\n      .join('; ');\n  }\n\n  /**\n   * Handle citation click\n   */\n  private handleCitationClick(link: HTMLAnchorElement): void {\n    const url = link.href;\n    if (url) {\n      window.open(url, '_blank', 'noopener,noreferrer');\n    }\n  }\n\n  /**\n   * Track download click\n   */\n  private trackDownload(attachment: HTMLAnchorElement): void {\n    const href = attachment.href;\n    this.log('Download tracked:', href);\n    // Analytics tracking could go here\n  }\n\n  /**\n   * Handle pagination click\n   */\n  private handlePagination(btn: HTMLButtonElement): void {\n    const container = btn.closest('.zp-Zotpress') as HTMLElement;\n    const page = btn.dataset.page;\n\n    if (container && page) {\n      container.dataset.page = page;\n      this.loadBibliography(container);\n    }\n  }\n\n  /**\n   * Handle search form submission\n   */\n  private async handleSearch(form: HTMLFormElement): Promise<void> {\n    const container = form.closest('.zp-Zotpress') as HTMLElement;\n    const input = form.querySelector('input[type=\"search\"]') as HTMLInputElement;\n\n    if (container && input) {\n      container.dataset.search = input.value;\n      await this.loadBibliography(container);\n    }\n  }\n\n  /**\n   * Show loading state\n   */\n  private showLoading(container: HTMLElement): void {\n    container.innerHTML = `\n      <div class=\"zp-Loading\" role=\"status\" aria-live=\"polite\">\n        <div class=\"zp-Spinner\" aria-hidden=\"true\"></div>\n        <span class=\"zp-sr-only\">Loading bibliography...</span>\n      </div>\n    `;\n  }\n\n  /**\n   * Show error message\n   */\n  private showError(container: HTMLElement, message: string): void {\n    container.innerHTML = `\n      <div class=\"zp-Message zp-Message--error\" role=\"alert\">\n        ${this.escapeHtml(message)}\n      </div>\n    `;\n  }\n\n  /**\n   * Announce to screen readers\n   */\n  private announceToScreenReader(message: string): void {\n    const announcer = document.createElement('div');\n    announcer.setAttribute('role', 'status');\n    announcer.setAttribute('aria-live', 'polite');\n    announcer.className = 'zp-sr-only';\n    announcer.textContent = message;\n\n    document.body.appendChild(announcer);\n    setTimeout(() => announcer.remove(), 1000);\n  }\n\n  /**\n   * Escape HTML entities\n   */\n  private escapeHtml(str: string): string {\n    const div = document.createElement('div');\n    div.textContent = str;\n    return div.innerHTML;\n  }\n\n  /**\n   * Cache management\n   */\n  private getCacheKey(params: Record<string, unknown>): string {\n    return JSON.stringify(params);\n  }\n\n  private getFromCache(key: string): unknown | null {\n    const entry = this.cache.get(key);\n    if (!entry) return null;\n\n    if (Date.now() - entry.timestamp > this.config.cacheTime) {\n      this.cache.delete(key);\n      return null;\n    }\n\n    return entry.data;\n  }\n\n  private setCache(key: string, data: unknown): void {\n    this.cache.set(key, { data, timestamp: Date.now() });\n  }\n\n  /**\n   * Debug logging\n   */\n  private log(...args: unknown[]): void {\n    if (this.config.debug) {\n      console.log('[Zotpress]', ...args);\n    }\n  }\n}\n\n// Export for module usage\nexport { Zotpress };\nexport type { ZotpressConfig, ZoteroItem, ZoteroCreator, ZoteroTag };\n\n// Auto-initialize when DOM is ready\nif (typeof document !== 'undefined') {\n  document.addEventListener('DOMContentLoaded', () => {\n    // Get config from global or data attribute\n    const configEl = document.querySelector('[data-zotpress-config]');\n    const config = configEl ? JSON.parse(configEl.getAttribute('data-zotpress-config') || '{}') : {};\n\n    // Initialize\n    (window as unknown as { Zotpress: Zotpress }).Zotpress = new Zotpress(config);\n  });\n}\n"
/* TODO: Port to ReScript. */
