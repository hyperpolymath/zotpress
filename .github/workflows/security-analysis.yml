# SPDX-License-Identifier: PMPL-1.0-or-later
name: Security Analysis (sanctify-php)

on:
  push:
    branches: [main]
    paths:
      - '**.php'
      - 'composer.json'
      - 'composer.lock'
  pull_request:
    branches: [main]
    paths:
      - '**.php'
      - 'composer.json'
      - 'composer.lock'
  schedule:
    - cron: '0 6 * * 1'  # Weekly on Monday at 6am

permissions: read-all

jobs:
  sanctify-analysis:
    name: Sanctify PHP Security Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Haskell
        uses: haskell-actions/setup@f9150cb1d140e9a9271700670baa38991e6fa25c # v2.10.3
        with:
          ghc-version: '9.6'
          cabal-version: '3.10'

      - name: Cache Cabal packages
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: |
            ~/.cabal/packages
            ~/.cabal/store
            dist-newstyle
          key: ${{ runner.os }}-cabal-${{ hashFiles('**/*.cabal') }}
          restore-keys: |
            ${{ runner.os }}-cabal-

      - name: Clone sanctify-php
        run: |
          git clone --depth 1 https://github.com/hyperpolymath/sanctify-php.git /tmp/sanctify-php

      - name: Build sanctify-php
        working-directory: /tmp/sanctify-php
        run: |
          cabal update
          cabal build

      - name: Run sanctify-php analysis
        run: |
          /tmp/sanctify-php/dist-newstyle/build/*/ghc-*/sanctify-php-*/x/sanctify-php/build/sanctify-php/sanctify-php \
            --format sarif \
            --output security-report.sarif \
            --severity high \
            lib/ src/ || true

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@b20883b0cd1f46c72ae0ba6d1090936928f9fa30 # v4.32.0
        if: always()
        with:
          sarif_file: security-report.sarif
        continue-on-error: true

      - name: Run sanctify-php (text output)
        run: |
          echo "## Security Analysis Report" >> $GITHUB_STEP_SUMMARY
          /tmp/sanctify-php/dist-newstyle/build/*/ghc-*/sanctify-php-*/x/sanctify-php/build/sanctify-php/sanctify-php \
            --format text \
            --severity medium \
            lib/ src/ 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true

  php-aegis-check:
    name: PHP Aegis Integration Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # v2.36.0
        with:
          php-version: '8.2'
          extensions: mbstring, intl, sodium
          coverage: none

      - name: Install dependencies
        run: composer install --no-progress --prefer-dist

      - name: Check php-aegis usage
        run: |
          echo "## PHP Aegis Integration Check" >> $GITHUB_STEP_SUMMARY
          if grep -r "Aegis\\\\" lib/ src/ 2>/dev/null; then
            echo "✓ php-aegis is being used in the codebase" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠ php-aegis is installed but not yet integrated" >> $GITHUB_STEP_SUMMARY
            echo "Consider using Aegis security functions for:" >> $GITHUB_STEP_SUMMARY
            echo "- Input validation (Aegis\Validation)" >> $GITHUB_STEP_SUMMARY
            echo "- Output sanitization (Aegis\Sanitization)" >> $GITHUB_STEP_SUMMARY
            echo "- Cryptographic operations (Aegis\Crypto)" >> $GITHUB_STEP_SUMMARY
          fi
