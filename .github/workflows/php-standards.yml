# SPDX-License-Identifier: MPL-2.0
# PHP Coding Standards & Static Analysis
# Enforces WordPress coding standards and runs comprehensive static analysis

name: PHP Standards

on:
  push:
    branches: [main, develop, 'claude/*']
    paths:
      - '**.php'
      - 'composer.json'
      - 'composer.lock'
      - 'phpstan.neon'
      - 'phpcs.xml'
      - '.github/workflows/php-standards.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - '**.php'
      - 'composer.json'
      - 'composer.lock'
      - 'phpstan.neon'
      - 'phpcs.xml'
  workflow_dispatch:

permissions: read-all

concurrency:
  group: php-standards-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ─────────────────────────────────────────────────────────────────────────────
  # PHP Syntax Check
  # ─────────────────────────────────────────────────────────────────────────────
  syntax:
    name: PHP Syntax (${{ matrix.php }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php: ['8.1', '8.2', '8.3', '8.4']

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup PHP ${{ matrix.php }}
        uses: shivammathur/setup-php@c541c155eee45413f5b09a52248675b1a2575231 # v2.31.1
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring, xml, curl, json, dom
          tools: parallel-lint

      - name: Check syntax
        run: parallel-lint --colors lib/ src/ zotpress.php

  # ─────────────────────────────────────────────────────────────────────────────
  # WordPress Coding Standards (PHPCS)
  # ─────────────────────────────────────────────────────────────────────────────
  phpcs:
    name: WordPress Coding Standards
    runs-on: ubuntu-latest
    needs: syntax

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup PHP
        uses: shivammathur/setup-php@c541c155eee45413f5b09a52248675b1a2575231 # v2.31.1
        with:
          php-version: '8.2'
          extensions: mbstring, xml, curl, json, dom
          tools: composer:v2, cs2pr

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@6849a6489940f00c2f30c0fb92c6274307ccb58a # v4.1.2
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: php-8.2-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: php-8.2-composer-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Run PHPCS (WordPress standards)
        run: |
          vendor/bin/phpcs \
            --standard=WordPress \
            --extensions=php \
            --ignore=vendor/,node_modules/,dist/ \
            --report=checkstyle \
            --report-file=phpcs-report.xml \
            lib/ src/ zotpress.php || true

      - name: Show PHPCS results
        run: |
          if [ -f phpcs-report.xml ]; then
            vendor/bin/phpcs \
              --standard=WordPress \
              --extensions=php \
              --ignore=vendor/,node_modules/,dist/ \
              lib/ src/ zotpress.php || true
          fi

      - name: Upload PHPCS report
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        if: always()
        with:
          name: phpcs-report
          path: phpcs-report.xml
          retention-days: 30

  # ─────────────────────────────────────────────────────────────────────────────
  # PHPStan Static Analysis
  # ─────────────────────────────────────────────────────────────────────────────
  phpstan:
    name: PHPStan (Level ${{ matrix.level }})
    runs-on: ubuntu-latest
    needs: syntax
    strategy:
      fail-fast: false
      matrix:
        level: [5, 6]

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup PHP
        uses: shivammathur/setup-php@c541c155eee45413f5b09a52248675b1a2575231 # v2.31.1
        with:
          php-version: '8.2'
          extensions: mbstring, xml, curl, json, dom
          tools: composer:v2

      - name: Cache Composer dependencies
        uses: actions/cache@6849a6489940f00c2f30c0fb92c6274307ccb58a # v4.1.2
        with:
          path: ~/.composer/cache
          key: php-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: php-composer-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Run PHPStan (Level ${{ matrix.level }})
        run: |
          vendor/bin/phpstan analyse \
            --level=${{ matrix.level }} \
            --memory-limit=512M \
            --error-format=github \
            lib/ src/ zotpress.php || true

  # ─────────────────────────────────────────────────────────────────────────────
  # Psalm Static Analysis
  # ─────────────────────────────────────────────────────────────────────────────
  psalm:
    name: Psalm Analysis
    runs-on: ubuntu-latest
    needs: syntax

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup PHP
        uses: shivammathur/setup-php@c541c155eee45413f5b09a52248675b1a2575231 # v2.31.1
        with:
          php-version: '8.2'
          extensions: mbstring, xml, curl, json, dom
          tools: composer:v2

      - name: Cache Composer dependencies
        uses: actions/cache@6849a6489940f00c2f30c0fb92c6274307ccb58a # v4.1.2
        with:
          path: ~/.composer/cache
          key: php-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: php-composer-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Run Psalm
        run: vendor/bin/psalm --no-cache --output-format=github || true

  # ─────────────────────────────────────────────────────────────────────────────
  # PHP Compatibility Check
  # ─────────────────────────────────────────────────────────────────────────────
  compatibility:
    name: PHP Compatibility (8.1+)
    runs-on: ubuntu-latest
    needs: syntax

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup PHP
        uses: shivammathur/setup-php@c541c155eee45413f5b09a52248675b1a2575231 # v2.31.1
        with:
          php-version: '8.2'
          extensions: mbstring, xml, curl, json, dom
          tools: composer:v2

      - name: Cache Composer dependencies
        uses: actions/cache@6849a6489940f00c2f30c0fb92c6274307ccb58a # v4.1.2
        with:
          path: ~/.composer/cache
          key: php-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: php-composer-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Check PHP 8.1+ compatibility
        run: |
          vendor/bin/phpcs \
            --standard=PHPCompatibilityWP \
            --runtime-set testVersion 8.1- \
            --extensions=php \
            --ignore=vendor/,node_modules/,dist/ \
            lib/ src/ zotpress.php || true

  # ─────────────────────────────────────────────────────────────────────────────
  # Security Check
  # ─────────────────────────────────────────────────────────────────────────────
  security:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup PHP
        uses: shivammathur/setup-php@c541c155eee45413f5b09a52248675b1a2575231 # v2.31.1
        with:
          php-version: '8.2'
          tools: composer:v2

      - name: Check for vulnerable dependencies
        run: composer audit

  # ─────────────────────────────────────────────────────────────────────────────
  # Summary
  # ─────────────────────────────────────────────────────────────────────────────
  summary:
    name: Standards Summary
    runs-on: ubuntu-latest
    needs: [syntax, phpcs, phpstan, psalm, compatibility, security]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "## PHP Standards Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Syntax | ${{ needs.syntax.result == 'success' && '✅ Pass' || '❌ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PHPCS (WordPress) | ${{ needs.phpcs.result == 'success' && '✅ Pass' || '⚠️ Issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PHPStan | ${{ needs.phpstan.result == 'success' && '✅ Pass' || '⚠️ Issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Psalm | ${{ needs.psalm.result == 'success' && '✅ Pass' || '⚠️ Issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Compatibility | ${{ needs.compatibility.result == 'success' && '✅ Pass' || '⚠️ Issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result == 'success' && '✅ Pass' || '❌ Vulnerabilities' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if syntax check failed
        if: needs.syntax.result == 'failure'
        run: exit 1
