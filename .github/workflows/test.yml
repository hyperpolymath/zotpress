# Zotpress - Test & Quality Workflow
# Runs PHP and ReScript/JavaScript tests with full CI checks

name: Test & Quality

on:
  push:
    branches: [main, develop, 'claude/*']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DENO_VERSION: '2.x'
  PHP_VERSION: '8.2'
  NODE_VERSION: '20.x'

jobs:
  # ─────────────────────────────────────────────────────────────────────────────
  # PHP Tests
  # ─────────────────────────────────────────────────────────────────────────────
  php-tests:
    name: PHP Tests (PHP ${{ matrix.php }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php: ['8.1', '8.2', '8.3']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP ${{ matrix.php }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring, xml, curl, json, dom
          coverage: xdebug
          tools: composer:v2

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: php-${{ matrix.php }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            php-${{ matrix.php }}-composer-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Run PHP syntax check
        run: composer lint

      - name: Run PHPUnit tests
        run: composer test

      - name: Upload coverage to Codecov
        if: matrix.php == '8.2'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/clover.xml
          flags: php
          fail_ci_if_error: false

  # ─────────────────────────────────────────────────────────────────────────────
  # PHP Static Analysis
  # ─────────────────────────────────────────────────────────────────────────────
  php-static-analysis:
    name: PHP Static Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, curl, json, dom

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: php-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: php-composer-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Run PHPStan
        run: composer phpstan
        continue-on-error: true

      - name: Run PHPCS (WordPress standards)
        run: composer phpcs
        continue-on-error: true

  # ─────────────────────────────────────────────────────────────────────────────
  # ReScript Build & Tests
  # ─────────────────────────────────────────────────────────────────────────────
  rescript-build:
    name: ReScript Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install ReScript
        run: npm install rescript --save-dev

      - name: Build ReScript
        run: npx rescript build
        continue-on-error: true

      - name: Check ReScript formatting
        run: npx rescript format -check src/rescript/ || true

      - name: Upload ReScript output
        uses: actions/upload-artifact@v4
        with:
          name: rescript-output
          path: lib/es6/
          retention-days: 1
        if: always()

  # ─────────────────────────────────────────────────────────────────────────────
  # Deno Lint & Format (Build Scripts)
  # ─────────────────────────────────────────────────────────────────────────────
  deno-checks:
    name: Deno Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Cache Deno dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/deno
            ~/.deno
          key: deno-${{ hashFiles('deno.json', 'deno.lock') }}
          restore-keys: deno-

      - name: Verify formatting
        run: deno fmt --check scripts/

      - name: Run linter
        run: deno lint scripts/

      - name: Run tests
        run: deno test --allow-read --allow-write
        continue-on-error: true

  # ─────────────────────────────────────────────────────────────────────────────
  # Build Check
  # ─────────────────────────────────────────────────────────────────────────────
  build:
    name: Build Assets
    runs-on: ubuntu-latest
    needs: [rescript-build, deno-checks]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download ReScript output
        uses: actions/download-artifact@v4
        with:
          name: rescript-output
          path: lib/es6/
        continue-on-error: true

      - name: Build CSS
        run: deno task build:css
        continue-on-error: true

      - name: Build JavaScript
        run: deno task build:js
        continue-on-error: true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7
        if: always()

  # ─────────────────────────────────────────────────────────────────────────────
  # WordPress Compatibility
  # ─────────────────────────────────────────────────────────────────────────────
  wordpress-compat:
    name: WordPress Compatibility
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, curl, json, dom

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Check PHP compatibility
        run: |
          vendor/bin/phpcs --standard=PHPCompatibilityWP --runtime-set testVersion 8.1- lib/ || true

      - name: Check WordPress minimum version
        run: |
          echo "Checking for WordPress 6.0+ compatibility markers..."
          # Add specific checks here if needed

  # ─────────────────────────────────────────────────────────────────────────────
  # All Checks Passed
  # ─────────────────────────────────────────────────────────────────────────────
  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [php-tests, php-static-analysis, rescript-build, deno-checks, build, wordpress-compat]
    if: always()

    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.php-tests.result }}" == "failure" ]]; then
            echo "PHP tests failed"
            exit 1
          fi
          echo "All critical checks passed"
